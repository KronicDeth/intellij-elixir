name: Test

on:
  pull_request:
  workflow_dispatch:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string
        default: ''
      elixir-version:
        description: 'Elixir version to use'
        required: false
        type: string
        default: '1.13.4'
      otp-version:
        description: 'OTP version to use'
        required: false
        type: string
        default: '24.3.4.6'
      upload-reports:
        description: 'Upload test reports as artifacts'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  matrix-setup:
    runs-on: ubuntu-latest
    outputs:
      idea-versions: '["2025.3.2"]'
    steps:
      - run: echo "Defining idea-versions matrix"

  seed-gradle-cache:
    needs: matrix-setup
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Stay with windows-2022 until https://github.com/erlef/setup-beam/commit/b94e7d372a9ef22d376b75a9374a7adeb0e2ea94 is released.
        os: [ubuntu-22.04, windows-2022]
        idea-version: ${{ fromJson(needs.matrix-setup.outputs.idea-versions) }}

    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      GRADLE_CACHE_SCOPE: ${{ github.event.pull_request.head.repo.id || github.repository_id }}
      GRADLE_CACHE_IDE_VERSION: ${{ matrix.idea-version }}

    steps:

      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Restore Gradle cache
        id: gradle-cache-restore
        uses: actions/cache/restore@v5
        with:
          path: |
            ${{ env.GRADLE_USER_HOME }}/caches
            ${{ env.GRADLE_USER_HOME }}/wrapper
            ${{ env.GRADLE_USER_HOME }}/notifications
          # Fork-scoped cache key:
          # - Avoids cross-PR cache poisoning between forks.
          # - Includes IDE version and build inputs to keep cache correctness.
          key: gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-${{ env.GRADLE_CACHE_IDE_VERSION }}-${{ hashFiles('build.gradle.kts', 'settings.gradle.kts', 'gradle.properties', 'gradle/libs.versions.toml', 'gradle/wrapper/gradle-wrapper.properties', 'buildSrc/build.gradle.kts', 'buildSrc/settings.gradle.kts') }}
          # Graceful fallback:
          # - First try exact IDE version match.
          # - Then fall back to the same fork scope on this OS/arch.
          restore-keys: |
            gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-${{ env.GRADLE_CACHE_IDE_VERSION }}-
            gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-

      - name: Setup Build Environment
        id: setup-env
        uses: ./.github/actions/setup-env
        with:
          elixir-version: ${{ inputs.elixir-version || '1.13.4' }}
          otp-version: ${{ inputs.otp-version || '24.3.4.6' }}
          idea-version: ${{ matrix.idea-version }}
          setup-elixir: false
          gradle-cache-read-only: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve External Dependencies
        id: resolve-external-deps
        run: ./gradlew :jps-builder:resolveExternalDependencies

      - name: Save Gradle cache
        id: gradle-cache-save
        if: always() && steps.gradle-cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: |
            ${{ env.GRADLE_USER_HOME }}/caches
            ${{ env.GRADLE_USER_HOME }}/wrapper
            ${{ env.GRADLE_USER_HOME }}/notifications
          key: ${{ steps.gradle-cache-restore.outputs.cache-primary-key }}

  test:
    needs: [matrix-setup, seed-gradle-cache]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Stay with windows-2022 until https://github.com/erlef/setup-beam/commit/b94e7d372a9ef22d376b75a9374a7adeb0e2ea94 is released.
        os: [ubuntu-22.04, windows-2022]
        idea-version: ${{ fromJson(needs.matrix-setup.outputs.idea-versions) }}

    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      GRADLE_CACHE_SCOPE: ${{ github.event.pull_request.head.repo.id || github.repository_id }}
      GRADLE_CACHE_IDE_VERSION: ${{ matrix.idea-version }}

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Restore Gradle cache
        id: gradle-cache-restore
        uses: actions/cache/restore@v5
        with:
          path: |
            ${{ env.GRADLE_USER_HOME }}/caches
            ${{ env.GRADLE_USER_HOME }}/wrapper
            ${{ env.GRADLE_USER_HOME }}/notifications
          # Fork-scoped cache key:
          # - Avoids cross-PR cache poisoning between forks.
          # - Includes IDE version and build inputs to keep cache correctness.
          key: gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-${{ env.GRADLE_CACHE_IDE_VERSION }}-${{ hashFiles('build.gradle.kts', 'settings.gradle.kts', 'gradle.properties', 'gradle/libs.versions.toml', 'gradle/wrapper/gradle-wrapper.properties', 'buildSrc/build.gradle.kts', 'buildSrc/settings.gradle.kts') }}
          # Graceful fallback:
          # - First try exact IDE version match.
          # - Then fall back to the same fork scope on this OS/arch.
          restore-keys: |
            gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-${{ env.GRADLE_CACHE_IDE_VERSION }}-
            gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-

      - name: Setup Build Environment
        id: setup-env
        uses: ./.github/actions/setup-env
        with:
          elixir-version: ${{ inputs.elixir-version || '1.13.4' }}
          otp-version: ${{ inputs.otp-version || '24.3.4.6' }}
          idea-version: ${{ matrix.idea-version }}
          gradle-cache-read-only: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Maven Central access
        run: |
          echo "=== DNS / Network / TLS info ==="
          ip -4 addr || true
          uname -a
          echo "Java version:"
          java -version || true
          
          echo
          echo "=== HTTP HEAD to POM (show headers) ==="
          curl -vI 'https://repo.maven.apache.org/maven2/commons-io/commons-io/2.21.0/commons-io-2.21.0.pom' || true
          
          echo
          echo "=== HTTP GET to POM (show first 200 bytes) ==="
          curl -v 'https://repo.maven.apache.org/maven2/commons-io/commons-io/2.21.0/commons-io-2.21.0.pom' -m 20 -sS -o /tmp/commons.pom || true
          head -c 200 /tmp/commons.pom || true
          
          echo
          echo "=== Try resolving dependency via Gradle (info) ==="
          ./gradlew --no-daemon --refresh-dependencies dependencies --configuration compileClasspath --info || true

      - name: Run Tests
        id: test
        run: ./gradlew --stacktrace check --scan

      - name: Publish Test Results
        id: publish-test-results-linux
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && runner.os == 'Linux'
        with:
          files: '**/build/test-results/**/*.xml'
          check_name: Test Results (${{ matrix.os }}, ${{ matrix.idea-version }})
          report_suite_logs: "error"

      - name: Publish Test Results
        id: publish-test-results-windows
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always() && runner.os == 'Windows'
        with:
          files: '**/build/test-results/**/*.xml'
          check_name: Test Results (${{ matrix.os }}, ${{ matrix.idea-version }})
          report_suite_logs: "error"

      - name: Upload Test Reports
        id: upload-test-reports
        uses: actions/upload-artifact@v6
        if: ${{ always() && inputs.upload-reports }}
        with:
          name: test-reports-${{ matrix.os }}-${{ matrix.idea-version }}
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          retention-days: 30
          include-hidden-files: true
          overwrite: true
          if-no-files-found: 'error'

  build-plugin-for-verifier:
    name: "Build Plugin for verifyPlugin"
    needs: seed-gradle-cache
    runs-on: ubuntu-22.04

    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      GRADLE_CACHE_SCOPE: ${{ github.event.pull_request.head.repo.id || github.repository_id }}
      GRADLE_CACHE_IDE_VERSION: '2025.3.2'

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Restore Gradle cache
        id: gradle-cache-restore
        uses: actions/cache/restore@v5
        with:
          path: |
            ${{ env.GRADLE_USER_HOME }}/caches
            ${{ env.GRADLE_USER_HOME }}/wrapper
            ${{ env.GRADLE_USER_HOME }}/notifications
          # Fork-scoped cache key:
          # - Avoids cross-PR cache poisoning between forks.
          # - Includes IDE version and build inputs to keep cache correctness.
          key: gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-${{ env.GRADLE_CACHE_IDE_VERSION }}-${{ hashFiles('build.gradle.kts', 'settings.gradle.kts', 'gradle.properties', 'gradle/libs.versions.toml', 'gradle/wrapper/gradle-wrapper.properties', 'buildSrc/build.gradle.kts', 'buildSrc/settings.gradle.kts') }}
          # Graceful fallback:
          # - First try exact IDE version match.
          # - Then fall back to the same fork scope on this OS/arch.
          restore-keys: |
            gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-${{ env.GRADLE_CACHE_IDE_VERSION }}-
            gradle-${{ runner.os }}-${{ runner.arch }}-${{ env.GRADLE_CACHE_SCOPE }}-

      - name: Setup Build Environment
        id: setup-env
        uses: ./.github/actions/setup-env
        with:
          setup-elixir: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          idea-version: '2025.3.2'

      - name: Build Plugin
        id: build-plugin
        run: ./gradlew buildPlugin

      - name: Upload Plugin Artifact
        id: upload-plugin
        uses: actions/upload-artifact@v6
        with:
          name: plugin-artifact
          path: build/distributions/*.zip
          retention-days: 1

  verify-plugin:
    needs: build-plugin-for-verifier
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        ide-version: ['ideaIU:253.30387.90', 'rubymine:2025.3.2']

    steps:
      - name: Download Plugin Artifact
        id: download-plugin
        uses: actions/download-artifact@v7
        with:
          name: plugin-artifact
          path: build/distributions

      - name: Verify Plugin
        id: verify-plugin
        uses: ChrisCarini/intellij-platform-plugin-verifier-action@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          ide-versions: ${{ matrix.ide-version }}

      - name: Print Verification Output
        id: print-verification-output
        if: always()
        run: |
          echo "Verification log:"
          cat "${{ steps.verify-plugin.outputs.verification-output-log-filename }}"

      - name: Upload Verify Reports
        id: upload-verify-reports
        uses: actions/upload-artifact@v6
        if: ${{ always() && inputs.upload-reports }}
        with:
          name: verify-plugin-reports-${{ matrix.ide-version }}
          path: |
            ${{ steps.verify-plugin.outputs.verification-output-log-filename }}
          retention-days: 30
