name: Test

on:
  pull_request:
  workflow_dispatch:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string
        default: ''
      elixir-version:
        description: 'Elixir version to use'
        required: false
        type: string
        default: '1.13.4'
      otp-version:
        description: 'OTP version to use'
        required: false
        type: string
        default: '24.3.4.6'
      upload-reports:
        description: 'Upload test reports as artifacts'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  matrix-setup:
    runs-on: ubuntu-latest
    outputs:
      idea-versions: '["2025.3", "LATEST-EAP-SNAPSHOT"]'
    steps:
      - run: echo "Defining idea-versions matrix"

  test:
    needs: matrix-setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        idea-version: ${{ fromJson(needs.matrix-setup.outputs.idea-versions) }}

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup Build Environment
        id: setup-env
        uses: ./.github/actions/setup-env
        with:
          elixir-version: ${{ inputs.elixir-version || '1.13.4' }}
          otp-version: ${{ inputs.otp-version || '24.3.4.6' }}
          idea-version: ${{ matrix.idea-version }}
          gradle-cache-read-only: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Tests
        id: test
        run: ./gradlew --stacktrace check --scan

      - name: Publish Test Results
        id: publish-test-results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: '**/build/test-results/**/*.xml'
          check_name: Test Results (${{ matrix.idea-version }})

      - name: Upload Test Reports
        id: upload-test-reports
        uses: actions/upload-artifact@v6
        if: ${{ always() && inputs.upload-reports }}
        with:
          name: test-reports-${{ matrix.idea-version }}
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          retention-days: 30
          include-hidden-files: true
          overwrite: true
          if-no-files-found: 'error'

  build-plugin-for-verifier:
    name: "Build Plugin for verifyPlugin"
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup Build Environment
        id: setup-env
        uses: ./.github/actions/setup-env
        with:
          setup-elixir: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          idea-version: '2025.3'

      - name: Build Plugin
        id: build-plugin
        run: ./gradlew buildPlugin

      - name: Upload Plugin Artifact
        id: upload-plugin
        uses: actions/upload-artifact@v6
        with:
          name: plugin-artifact
          path: build/distributions/*.zip
          retention-days: 1

  verify-plugin:
    needs: build-plugin-for-verifier
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        ide-version: ['253.28294.334']

    steps:
      - name: Download Plugin Artifact
        id: download-plugin
        uses: actions/download-artifact@v7
        with:
          name: plugin-artifact
          path: build/distributions

      - name: Verify Plugin
        id: verify-plugin
        uses: ChrisCarini/intellij-platform-plugin-verifier-action@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          ide-versions: ideaIU:${{ matrix.ide-version }}

      - name: Print Verification Output
        id: print-verification-output
        if: always()
        run: |
          echo "Verification log:"
          cat "${{ steps.verify-plugin.outputs.verification-output-log-filename }}"

      - name: Upload Verify Reports
        id: upload-verify-reports
        uses: actions/upload-artifact@v6
        if: ${{ always() && inputs.upload-reports }}
        with:
          name: verify-plugin-reports-${{ matrix.ide-version }}
          path: |
            ${{ steps.verify-plugin.outputs.verification-output-log-filename }}
          retention-days: 30
